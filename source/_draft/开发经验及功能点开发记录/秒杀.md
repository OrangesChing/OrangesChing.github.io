---
title: 秒杀功能开发
date: 2021-02-8 08:59:43
tags:
  - 秒杀
categories:
  - 开发经验及功能点开发记录
---

# 问题点

**1. 如何保证不卖超**
有两种情况可能会导致卖超：（1）一个用户同时发出了多个请求，如果库存足够，没加限制，用户就可以下多个订单。（2）减库存的sql上没有加库存数量的判断，并发的时候也会导致把库存减成负数。
我们的解决办法：
对于（1）：前端加验证码，防止用户同时发出多个请求，在后端的miaosha_order表中，对user_id和goods_id加唯一索引，确保一个用户对一个商品绝对不会生成两个订单。
对于（2）：我们的减库存的sql上应该加上库存数量的判断：
![图片描述](D:\OrangeBlog\source\_posts\开发经验及功能点开发记录\秒杀\601cf23e09085e3607000140.png)
数据库更新记录的时候会加锁，实际上是串行的执行update的，因此绝对不会卖超！

**2. Redis中的库存如何与DB中的库存保持一致？**
Redis中的数量不是库存，它的作用仅仅时候只是为了阻挡多余的请求透传到db，起到一个保护DB的作用。因为秒杀商品的数量是有限的，比如只有10个，让1万个请求去访问DB是没有意义的，因为最多只有10个请求会下单成功，剩余的9990个请求都是无效的，是可以不用去访问db而直接失败的。
因此，这是一个伪问题，我们是不需要保持一致的。

**3. Redis预减成功，DB扣减库存失败怎么办？**
两大类情况可导致redis预减成功而DB扣减失败：
（1） 如果一个用户发出了多个请求（不管何种手段），而这些所有的请求比所有其他用的请求都更快的到达了服务器，这个时候如果库存足够，就会出现redis预减多次，而只能下单成功一次（前提是：这个用户的多个请求比网站的其他用户的请求都更快的到达服务器，这在网络环境不可知的情况下，基本不可能）
（2） 还有就是在生成订单的过程中发生了不可预料的异常，也会导致redis扣减成功，而db扣减失败（如果是DB出现了异常，可能所有的订单都无法生成，但是只要存在redis预减，活动就可以正常结束）
因此，在初始化的时候，redis中的数量可以多于db的库存数量。
出现这种情况的后果是什么？
（1） 对用户而言，秒杀不中是正常现象，秒杀中才是意外，单个用户能否秒杀中本来就是小概率事件，出现这种情况对用户而言是没有任何影响的。
（2） 对商户而言，本来就是为了做活动拉流量拉人气的，卖不完还可以省一部分费用，但是活动还是正常参与了，也是没有任何影响
（3） 对网站而言，网站最重要的是用户体验，只要网站不崩，用户不骂娘，对网站也没有任何影响。
所以，卖不完是完全允许的，但是卖超是绝对不允许的！卖超的这部分钱商家是不会出的，需要网站自己来出。

**4. 为什么Redis中的数量会减成负数？**
![图片描述](D:\OrangeBlog\source\_posts\开发经验及功能点开发记录\秒杀\601cf263091ad06a08190181.png)
假如redis中的数量是1，这个时候同时过来100个请求，大家一起去执行decr,数量就会减成-99，这是正常的。

**5. 为什么要单独维护一个秒杀结束的标志？**
（1） 前面也提过，所有的秒杀相关的接口都要加上活动是否结束的标志，如果结束就直接返回了，包括轮询的接口，防止一直轮询没法结束。
（2） 管理后台也可以手动的更改这个标志，防止出现活动开始以后就没法结束这种意外的发生。

**6. 如果用户秒杀成成功了，但是没有付款怎么办？**
一般网站都会有下单30分钟不支付订单自动取消这样的操作，此时就需要把库存再加回去，因此又叫回仓。
可以在创建订单以后，把订单写入到延迟队列里面（RabbitMQ、RocketMQ都支持），如果在有效期之内用户做了付款，则从队列删除，否则等延迟队列数据出队的时候，再去查询数据库订单的状态，如果是未支付则需要回仓。回仓无非就是重置redis和mysql的数据，包括一些秒杀结束的状态等等。